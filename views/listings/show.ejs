<% layout("/layouts/boilerplate") %>
<div class="row mt-5">
    <div class="col-6 offset-3">
        <h3><b><%= listing.title %></b></h3>
    </div>
        <div class="card col-6 offset-3 show-card listing-card">
            <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="Image of <%= listing.title %>">
            <div class="card-body">
                <p class="card-text">
                    <b>Owner:</b> <%= listing.owner.username %>
                    <br>
                    <br>
                    <%= listing.description %>
                    <br>
                    <br>
                    <b>Price:</b> &#8377 <%= listing.price.toLocaleString("en-IN") %>
                    <br>
                    <b>Location:</b> <%= listing.location %>
                    <br>
                    <b>Country:</b> <%= listing.country %>
                </p>
            </div>
        </div>         
</div>

<% if(currUser && currUser._id.equals(listing.owner._id)) { %>
<div class="btns">
    <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark col-1 offset-3 ">Edit</a>

    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
        <button class="btn btn-dark offset-5 del-btn">Delete</button>
    </form>
</div>
<% } %>

<div class="col-6 offset-3 mt-5 mb-5">
    <% if(currUser) { %>
    <h4><b>Leave a Review</b></h4>
    <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
        <div class="mb-3 mt-3">
            <label for="rating" class="form-label"><b>Rating</b></label>
            <fieldset class="starability-basic">
                <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                <label for="first-rate1" title="Terrible">1 star</label>
                <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                <label for="first-rate2" title="Not good">2 stars</label>
                <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                <label for="first-rate3" title="Average">3 stars</label>
                <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                <label for="first-rate4" title="Very good">4 stars</label>
                <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                <label for="first-rate5" title="Amazing">5 stars</label>
            </fieldset>
        </div>

        <div class="mb-3 mt-3">
            <label for="comment" class="form-label"><b>Comment</b></label>
            <textarea id="comment" name="review[comment]" rows="3" cols="50" class="form-control" required></textarea>
            <div class="invalid-feedback">
                Please Enter a Comment!
            </div>
        </div>
        <button class="btn btn-outline-dark">Submit</button>
    </form>
    <% } %>
</div>


<div class="col-6 offset-3 mt-5 mb-5">
    <h4 class="mt-5"><b>Reviews</b></h4>

    <% if(listing.reviews.length === 0) { %>
        <h6>No reviews yet!</h6>
    <% } else { %>
        
        <% for(review of listing.reviews) { %>
        <div class="card mb-3 col-5 ms-3 me-3 review-card">
            <div class="card-body">
                <h5 class="card-subtitle mb-2 "><b>@<%= review.author.username %> </b></h5>
                <p class="starability-result card-text" 
                    data-rating="<%= review.rating %>">
                </p>
                <!--<p class="createdAt"><%= review.createdAt %> </p>-->
                <p class="card-text"><%= review.comment %></p>
            </div>
            <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                <button class="btn btn-dark btn-sm del-btn mb-3 ms-3" formaction="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">Delete</button>
            </form>
        </div>
        <% } %>
    <% } %>
    </div>  
</div>

<div class="col-6 offset-3 mt-3 mb-5">
    <div class="map-container">
        <div class="card-body">
            <h3><b>Where you'll be</b></h3>
        </div>
        <div id='map'></div>
    </div>
</div>


<!-- MapTiler SDK -->
<script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.8.0/maptiler-sdk.umd.min.js"></script>
<link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.8.0/maptiler-sdk.css" rel="stylesheet" />

<script>
  // ✅ Pass API key safely
  const MAP_TOKEN = "<%- mapToken %>";
  maptilersdk.config.apiKey = MAP_TOKEN;

  // ✅ Safely inject location/country strings
  const locationName = "<%- listing.location %>, <%- listing.country %>";

  async function loadMap() {
    try {
      const response = await fetch(
        `https://api.maptiler.com/geocoding/${encodeURIComponent(locationName)}.json?key=${MAP_TOKEN}`
      );
      const data = await response.json();

      if (data.features && data.features.length > 0) {
        const [lng, lat] = data.features[0].geometry.coordinates;

        const map = new maptilersdk.Map({
          container: 'map',
          style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAP_TOKEN}`,
          center: [lng, lat],
          zoom: 12
        });

        new maptilersdk.Marker().setLngLat([lng, lat]).addTo(map);
      } else {
        document.getElementById('map').innerHTML = "<p>Location not found on map</p>";
      }
    } catch (err) {
      console.error("Geocoding error:", err);
      document.getElementById('map').innerHTML = "<p>Map could not be loaded</p>";
    }
  }

  loadMap();
</script>